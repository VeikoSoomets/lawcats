{% extends "base.html" %}
{% block title %}{% trans %}Search Requests{% endtrans %} {% endblock %}
{% block content %}
<div ng-app="querywordsApp" ng-controller="QuerywordsController as qc">

  <!-- TODO: add limit bar ? -->
  {% raw %}

  <div class="row">
    <div class="col-xs-12">
      <ul class="nav nav-pills nav-justified" role="tablist"> <!-- top tabs area -->

        <li role="presentation" class="active">
          <a
            href="#querywords"
            aria-controls="querywords"
            role="pill"
            data-toggle="pill">
            {% endraw %}{% trans %}Querywords{% endtrans %}{% raw %}
          </a>
        </li>

        <li role="presentation">
          <a
            href="#add-new"
            aria-controls="add new"
            role="pill"
            data-toggle="pill">
            {% endraw %}{% trans %}Add new{% endtrans %}{% raw %}
          </a>
        </li>

      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="tab-content"> <!-- Main content -->
        <div class="tab-pane fade in active" id="querywords"> <!-- querywords table area -->
          <table class="table table-hover">
            <thead>
              <tr> 
                <th
                  ng-click="qc.setQuerywordOrder('queryword')"
                  class="cursor-hoverable">
                  {% endraw %}{% trans %}Queryword{% endtrans %}{% raw %}

                  <span
                    ng-show="qc.querywordOrder === 'queryword'"
                    class="glyphicon glyphicon-chevron-up"></span>
                  <span
                    ng-show="qc.querywordOrder === '-queryword'"
                    class="glyphicon glyphicon-chevron-down"></span>
                </th>
                <th
                  ng-click="qc.setQuerywordOrder('request_start')"
                  class="cursor-hoverable">
                  {% endraw %}{% trans %}Start Date{% endtrans %}{% raw %}

                  <span
                    ng-show="qc.querywordOrder === 'request_start'"
                    class="glyphicon glyphicon-chevron-up"></span>
                  <span
                    ng-show="qc.querywordOrder === '-request_start'"
                    class="glyphicon glyphicon-chevron-down"></span>
                </th>
                <th
                  ng-click="qc.setQuerywordOrder('request_frequency')"
                  class="cursor-hoverable">
                  {% endraw %}{% trans %}Search Frequency{% endtrans %}{% raw %}

                  <span
                    ng-show="qc.querywordOrder === 'request_frequency'"
                    class="glyphicon glyphicon-chevron-up"></span>
                  <span
                    ng-show="qc.querywordOrder === '-request_frequency'"
                    class="glyphicon glyphicon-chevron-down"></span>
                </th>
                <th>
                  {% endraw %}{% trans %}Sources{% endtrans %}{% raw %}
                </th>
                <th>
                  {% endraw %}{% trans %}Actions{% endtrans %}{% raw %}
                </th>
              </tr> 
            </thead>
            <tbody>
              <tr
                class="modal-opener" ng-repeat="queryword in qc.querywords | orderBy:qc.querywordOrder:false track by $index" ng-click="qc.openModal(queryword)">
                <td ng-bind="queryword.queryword ? queryword.queryword : '{% endraw %}{% trans %}All updates{% endtrans %}{% raw %}'"></td>
                <td ng-bind="queryword.request_start"></td>
                <td ng-bind="queryword.request_frequency / 60"></td>
                <td ng-bind="queryword.categories.length"></td>
                <td>
                  <button
                    class="btn btn-danger"
                    ng-click="qc.removeQueryword(queryword);$event.stopPropagation()">{% endraw %}{% trans %}Remove{% endtrans %}{% raw %}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="progress progress-striped active" ng-hide="qc.loaded">
            <div class="progress-bar"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
            </div>
          </div>

          <div
            ng-show="qc.loaded && qc.querywords.length === 0"
            class="alert alert-info"
            role="alert">
            {% endraw %}{% trans %}No querywords{% endtrans %}{% raw %}.
          </div>
        </div>


        <div class="tab-pane fade" id="add-new"> <!-- New queryword area -->
          <form class="form-horizontal" role="form">

            <div class="form-group"> <!-- querywords -->
              <label
                class="control-label col-sm-2"
                for="new-queryword-querywords">
                {% endraw %}{% trans %}Querywords{% endtrans %}{% raw %}
                <a tabindex="0" class="badge" role="button" data-toggle="popover" data-trigger="focus"
                 data-content="{% endraw %}{% trans %}You can add multiple querywords by separating them with a comma.{% endtrans %}{% raw %}">?</a>
              </label>



              <div class="col-sm-10">
                <input
                  type="text"
                  id="new-queryword-querywords"
                  class="form-control"
                  ng-model="qc.newQueryword.queryword"
                  placeholder="{% endraw %}{% trans %}topic, another topic{% endtrans %}{% raw %}" />
              </div>
            </div>

            <div class="form-group"> <!-- sources -->
              <label
                class="control-label col-sm-2">
                {% endraw %}{% trans %}Sources{% endtrans %}{% raw %}
                <a tabindex="0" class="badge" role="button" data-toggle="popover" data-trigger="focus"
                 data-content="{% endraw %}{% trans %}Choose from which sources you'd like to start receiving updates.{% endtrans %}{% raw %}">?</a>
              </label>

              <div class="col-sm-10">

              <p>
                <button class="btn btn-primary" ng-click="qc.requestSource()">
                    {% endraw %}{% trans %}Request your own source here!{% endtrans %}{% raw %}
                </button>
              </p>

                {% endraw %}
                  <span class="hr-line">{% trans %}or search from existing sources{% endtrans %}</span>
                {% raw %}

                <ng-categories
                  ng-model="qc.newQueryword.sources"
                  categories="qc.sources"
                  forbidden-categories="['Uudistearhiivid', 'Sanktsioonid', 'Kohturegistrid']">
                </ng-categories>

              </div>
            </div>

            <div class="form-group"> <!-- frequency -->
              <label
                class="control-label col-sm-2"
                for="new-queryword-querywords">
                {% endraw %}{% trans %}Search frequency{% endtrans %}{% raw %}
                <a tabindex="0" class="badge" role="button" data-toggle="popover" data-trigger="focus"
                 data-content="{% endraw %}{% trans %}Choose how often you'd like our robots to search for your request.{% endtrans %}{% raw %}">?</a>
              </label>

              <div class="col-sm-10">
                <input
                  class="form-control"
                  type="range"
                  ng-model="qc.newQueryword.frequency"
                  min="1"
                  max="1000" />
              </div>
            </div>

            <div class="form-group">
              <div class="col-sm-10 col-sm-offset-2">
                <button
                  class="btn btn-primary"
                  ng-click="qc.createQueryword()">
                  {% endraw %}{% trans %}Add{% endtrans %}{% raw %}
                </button>
              </div>
            </div>

          </form>
          
        </div>
      </div>
    </div>
  </div>
  
  <!-- modal -->
  <div id="queryword-modal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <!-- close button -->
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <!-- Main header of modal -->
          <h4
            class="modal-title"
            ng-bind="qc.modalQueryword.queryword ? qc.modalQueryword.queryword : '{% endraw %}{% trans %}All updates{% endtrans %}{% raw %}'"></h4>
        </div>
        <div class="modal-body">
          <ul class="list-group">
            <!-- queryword properties collection -->
            <li class="list-group-item">
              {% endraw %}{% trans %}Monthly Searches{% endtrans %}{% raw %}: <span class="text-info" ng-bind="qc.modalQueryword.monthly_searches"></span>
            </li>
            <li class="list-group-item">
              {% endraw %}{% trans %}Start Date{% endtrans %}{% raw %}: <span class="text-info" ng-bind="qc.modalQueryword.request_start"></span>
            </li>
            <li class="list-group-item">
              {% endraw %}{% trans %}Search frequency: Every{% endtrans %}{% raw %} <span
                                  class="text-info"
                                  ng-bind="qc.modalQueryword.request_frequency / 60"></span> {% endraw %}{% trans %}hours{% endtrans %}{% raw %}.
            </li>
            <li class="list-group-item">
              {% endraw %}{% trans %}Sources{% endtrans %}{% raw %}:
              <ul class="list-unstyled">
                <li ng-repeat="source in qc.modalQueryword.categories">
                  <span ng-bind="source" class="text-info"></span>
                  <button
                    class="btn btn-danger btn-sm"
                    ng-click="qc.removeSource(source)">
                    &times;
                  </button>
                </li>
              </ul>
            </li>
            <li class="list-group-item">
              {% endraw %}{% trans %}Change Frequency: Every {% endtrans %}{% raw %}
              <span ng-bind="qc.newFrequency" class="text-info"></span>
              {% endraw %}{% trans %} hours.{% endtrans %}{% raw %}
              <input type="range" ng-model="qc.newFrequency" min="1" max="10" />
              <button class="btn btn-primary" ng-click="qc.updateFrequency()">
                {% endraw %}{% trans %}Update frequency{% endtrans %}{% raw %}
              </button>
            </li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">
            {% endraw %}{% trans %}Close{% endtrans %}{% raw %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="request-source-modal"> <!-- modal for selecting source by the user -->
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <!-- close button -->
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>

          <h4 class="modal-title">
            {% endraw %}{% trans %}Request your own source{% endtrans %}{% raw %}
          </h4>
        </div>

        <div class="modal-body">
          <form class="form-horizontal">
            <div class="form-group">
              <label
                class="control-label col-sm-2"
                for="new-source-url-input">
                {% endraw %}{% trans %}URL for source{% endtrans %}{% raw %}
                <a tabindex="0" class="badge" role="button" data-toggle="popover" data-trigger="focus"
                 data-content="{% endraw %}{% trans %}Make sure it begins with http or www{% endtrans %}{% raw %}">?</a>
              </label>

              <div class="col-sm-10">
                <input
                  id="new-source-url-input"
                  class="form-control"
                  type="text"
                  placeholder="http://"
                  ng-model="qc.newSourceUrl" />
              </div>
            </div>

            <div class="form-group">
              <label
                class="control-label col-sm-2"
                for="new-source-description-input">
                {% endraw %}{% trans %}Brief description{% endtrans %}{% raw %}
                <a tabindex="0" class="badge" role="button" data-toggle="popover" data-trigger="focus"
                 data-content="{% endraw %}{% trans %}If our engine fails to implement your source automatically, this helps us understand what were you trying to search.{% endtrans %}{% raw %}">?</a>
              </label>

              <div class="col-sm-10">
                <textarea
                  id="new-source-description-input"
                  class="form-control"
                  type="text"
                  ng-model="qc.newSourceDescription" ></textarea>
              </div>
            </div>

            <div class="form-group">
              <div class="col-sm-10 col-sm-offset-2">

                <div class="progress progress-striped active" ng-show="qc.loading">
                  <div class="progress-bar"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                  </div>
                </div>

                <div ng-hide="qc.loading"><button
                  class="btn btn-primary"
                  ng-click="qc.sendNewSource()">
                  {% endraw %}{% trans %}Send request{% endtrans %}{% raw %}
                </button>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">
            {% endraw %}{% trans %}Close{% endtrans %}{% raw %}
          </button>
        </div>
      </div>
    </div>
  </div>
  
  {% endraw %}
</div>
{% endblock %}
{% block footer %}
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
<script type="text/javascript" src="/static/js/controllers/querywords.js"></script>
{% endblock %}